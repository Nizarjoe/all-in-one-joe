<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Personal Management • All-in-One</title>

  <!-- Chart.js + XLSX + docx via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.5.0/docx.umd.min.js"></script>

  <style>
    /* -------------------------
       Modern Minimal Design
       ------------------------- */
    :root{
      --bg:#0f1724;
      --panel:#0b1220;
      --muted:#98a0b3;
      --text:#e6eef8;
      --card:#0d1623;
      --accent:#38bdf8;    /* sky-ish */
      --accent-2:#60a5fa;
      --success:#22c55e;
      --danger:#ef4444;
      --glass: rgba(255,255,255,0.03);
      --radius:12px;
      --gap:14px;
      font-size:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg) 0%, #061226 100%);color:var(--text);font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;}
    a{color:inherit}
    .wrap{max-width:1100px;margin:20px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:#012; font-weight:800;
      box-shadow:0 6px 18px rgba(34,197,94,0.06);
    }
    h1{font-size:18px;margin:0}
    .controls{display:flex;gap:8px;align-items:center}
    .btn{background:var(--glass);border:1px solid rgba(255,255,255,0.04);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#04202a;border:none}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04)}
    nav.tabs{display:flex;gap:8px;margin-top:18px;flex-wrap:wrap}
    nav.tabs button{background:transparent;border:1px solid transparent;padding:10px 12px;border-radius:10px;color:var(--muted);cursor:pointer}
    nav.tabs button.active{color:var(--text);background:linear-gradient(90deg,rgba(255,255,255,0.03),transparent);border:1px solid rgba(255,255,255,0.04)}
    .subtoggles{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}

    main{margin-top:18px}
    section{display:none}
    section.active{display:block}

    .grid{display:grid;gap:var(--gap)}
    .grid-3{grid-template-columns:repeat(3,1fr)}
    .grid-2{grid-template-columns:repeat(2,1fr)}
    @media (max-width:920px){ .grid-3{grid-template-columns:1fr} .grid-2{grid-template-columns:1fr} }

    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.03); padding:16px; border-radius:var(--radius); box-shadow: 0 6px 30px rgba(2,6,23,0.5); }
    .card h3{margin:0 0 8px 0;color:var(--muted);font-size:14px}
    .muted{color:var(--muted);font-size:13px}
    .stat-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .stat{flex:1;background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
    .stat strong{display:block;font-size:18px;margin-top:6px;color:var(--text)}

    input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);outline:none}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.02);text-align:left;color:var(--muted)}
    tr td strong{color:var(--text)}
    .pill{padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,0.03);font-size:13px;color:var(--muted)}

    footer{margin-top:26px;text-align:center;color:var(--muted);font-size:13px}

    /* Login modal */
    .login-wrap{min-height:72vh;display:flex;align-items:center;justify-content:center}
    .login-card{width:100%;max-width:420px;padding:22px;border-radius:14px;background:linear-gradient(180deg,#071428,#0b1a2b);box-shadow:0 10px 40px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
    .login-card h2{margin:0 0 14px 0;font-size:20px}
    .small{font-size:13px;color:var(--muted)}

    /* Toggle switch */
    .switch{display:inline-flex;align-items:center;gap:8px}
    .switch input{display:none}
    .switch .track{width:48px;height:26px;background:#061226;border-radius:999px;border:1px solid rgba(255,255,255,0.04);position:relative;cursor:pointer}
    .switch .dot{width:18px;height:18px;border-radius:50%;background:#e6eef8;position:absolute;top:3px;left:4px;transition:all .18s ease}
    .switch input:checked + .track{background:linear-gradient(90deg,var(--accent),var(--accent-2))}
    .switch input:checked + .track .dot{left:26px;background:#012;box-shadow:0 6px 20px rgba(3,12,28,0.45)}

    /* helper */
    .row{display:flex;gap:12px;align-items:center}
    .right{margin-left:auto}
    .muted-tip{font-size:12px;color:var(--muted);margin-top:8px}
    .tiny{font-size:12px;color:var(--muted)}
    .icon-btn{background:transparent;border:none;color:var(--muted);cursor:pointer;padding:6px;border-radius:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">PM</div>
        <div>
          <h1>Personal Management</h1>
          <div class="tiny">All-in-one • ringan • offline</div>
        </div>
      </div>
      <div class="controls">
        <button id="btn-backup" class="btn ghost" title="Backup JSON">Backup</button>
        <label for="import-json" class="btn" style="cursor:pointer">Import</label>
        <input id="import-json" type="file" accept="application/json" style="display:none">
        <button id="btn-logout" class="btn ghost" title="Logout">Logout</button>
      </div>
    </header>

    <!-- top tabs -->
    <nav class="tabs" id="tabs"></nav>

    <!-- toggles for visualizations -->
    <div class="subtoggles">
      <label class="switch"><input id="toggle-fin" type="checkbox" checked><span class="track"><span class="dot"></span></span><span class="small">Finance Chart</span></label>
      <label class="switch"><input id="toggle-tasks" type="checkbox" checked><span class="track"><span class="dot"></span></span><span class="small">Tasks Chart</span></label>
      <label class="switch"><input id="toggle-agenda" type="checkbox" checked><span class="track"><span class="dot"></span></span><span class="small">Agenda Chart</span></label>
    </div>

    <main>
      <!-- LOGIN -->
      <div id="login-screen" class="login-wrap" style="display:none">
        <div class="login-card">
          <h2>Masuk ke Personal Management</h2>
          <div class="small">Silakan login atau daftar akun cepat (disimpan localStorage).</div>
          <div style="margin-top:12px">
            <label class="tiny">Username</label>
            <input id="login-user" placeholder="username" />
            <label class="tiny">Password</label>
            <input id="login-pass" type="password" placeholder="password" />
            <div style="display:flex;gap:8px;margin-top:10px">
              <button id="btn-login" class="btn primary">Masuk</button>
              <button id="btn-register" class="btn">Daftar</button>
              <button id="btn-guest" class="btn ghost">Guest</button>
            </div>
            <div class="muted-tip">Catatan: akun tersimpan di local browser (bukan aman untuk data sensitif).</div>
          </div>
        </div>
      </div>

      <!-- APP SECTIONS -->
      <section id="tab-dashboard" class="active">
        <div class="grid grid-3">
          <div class="card">
            <h3>Ringkasan Keuangan</h3>
            <div class="stat-row">
              <div class="stat"><div class="muted">Saldo</div><strong id="dash-saldo">Rp 0</strong></div>
              <div class="stat"><div class="muted">Pemasukan (Bln)</div><strong id="dash-income">Rp 0</strong></div>
              <div class="stat"><div class="muted">Pengeluaran (Bln)</div><strong id="dash-expense">Rp 0</strong></div>
            </div>
          </div>
          <div class="card">
            <h3>Tugas & Catatan</h3>
            <div class="stat-row">
              <div class="stat"><div class="muted">Tugas</div><strong id="dash-tasks">0</strong></div>
              <div class="stat"><div class="muted">Catatan</div><strong id="dash-notes">0</strong></div>
              <div class="stat"><div class="muted">Agenda</div><strong id="dash-agenda">0</strong></div>
            </div>
          </div>
          <div class="card">
            <h3>Aksi Cepat</h3>
            <div style="display:flex;flex-direction:column;gap:10px">
              <button class="btn primary" onclick="switchTab('keuangan')">Tambah Transaksi</button>
              <button class="btn" onclick="switchTab('notes')">Tambah Catatan</button>
              <button class="btn" onclick="switchTab('tasks')">Tambah Tugas</button>
              <button class="btn ghost" onclick="switchTab('visual')">Lihat Visualisasi</button>
            </div>
          </div>
        </div>

        <div class="grid grid-2" style="margin-top:14px">
          <div class="card">
            <h3>Grafik Bulanan</h3>
            <canvas id="dash-chart" height="140"></canvas>
          </div>
          <div class="card">
            <h3>Agenda Mendatang</h3>
            <div id="upcoming-list" class="muted">Belum ada agenda.</div>
          </div>
        </div>
      </section>

      <!-- KEUANGAN -->
      <section id="tab-keuangan">
        <div class="card">
          <h3>Input Transaksi</h3>
          <div class="grid grid-3">
            <div>
              <label>Tanggal</label>
              <input type="date" id="fin-date" />
            </div>
            <div>
              <label>Jenis</label>
              <select id="fin-type"><option value="income">Pemasukan</option><option value="expense">Pengeluaran</option></select>
            </div>
            <div>
              <label>Kategori</label>
              <input id="fin-cat" placeholder="Gaji, Makan, Transport..." />
            </div>
            <div style="grid-column:1/3">
              <label>Deskripsi</label>
              <input id="fin-desc" placeholder="Contoh: Gaji bulanan" />
            </div>
            <div>
              <label>Jumlah</label>
              <input id="fin-amount" type="number" placeholder="0" />
            </div>
            <div class="row" style="grid-column:1/3">
              <button class="btn primary" onclick="addTransaction()">Simpan</button>
              <button class="btn" onclick="clearFinanceForm()">Reset</button>
              <button class="btn ghost right" onclick="deleteAll('finances')">Hapus Semua</button>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Daftar Transaksi</h3>
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
            <label class="tiny">Filter Bulan</label>
            <select id="fin-filter" onchange="renderFinance()"></select>
            <div class="right muted-tip">Saldo sekarang: <strong id="fin-sum">Rp 0</strong></div>
          </div>
          <div style="overflow:auto">
            <table>
              <thead><tr><th>Tanggal</th><th>Jenis</th><th>Kategori</th><th>Deskripsi</th><th>Jumlah</th><th></th></tr></thead>
              <tbody id="fin-tbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- CATATAN -->
      <section id="tab-notes">
        <div class="card">
          <h3>Catatan Harian</h3>
          <label>Isi Catatan</label>
          <textarea id="note-text" rows="3" placeholder="Tulis catatan..."></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn primary" onclick="addNote()">Tambah Catatan</button>
            <button class="btn ghost" onclick="deleteAll('notes')">Hapus Semua</button>
          </div>
        </div>
        <div class="card">
          <h3>Daftar Catatan</h3>
          <div id="notes-list" class="muted">Belum ada catatan.</div>
        </div>
      </section>

      <!-- TUGAS -->
      <section id="tab-tasks">
        <div class="card">
          <h3>Tambah Tugas</h3>
          <div class="grid grid-3">
            <div><label>Tugas</label><input id="task-text" placeholder="Tugas baru..." /></div>
            <div><label>Tanggal</label><input id="task-date" type="date" /></div>
            <div class="row" style="align-items:end"><button class="btn primary" onclick="addTask()">Tambah</button><button class="btn ghost" onclick="deleteAll('tasks')">Hapus Semua</button></div>
          </div>
        </div>
        <div class="card">
          <h3>Daftar Tugas</h3>
          <div id="tasks-list" class="muted">Belum ada tugas.</div>
        </div>
      </section>

      <!-- AGENDA -->
      <section id="tab-agenda">
        <div class="card">
          <h3>Tambah Jadwal</h3>
          <div class="grid grid-2">
            <div><label>Tanggal</label><input id="evt-date" type="date" /></div>
            <div><label>Waktu</label><input id="evt-time" type="time" /></div>
            <div style="grid-column:1/-1"><label>Deskripsi</label><input id="evt-desc" placeholder="Contoh: Meeting proyek" /></div>
            <div style="grid-column:1/-1" class="row"><button class="btn primary" onclick="addEvent()">Simpan</button><button class="btn ghost" onclick="deleteAll('events')">Hapus Semua</button></div>
          </div>
        </div>
        <div class="card">
          <h3>Daftar Agenda</h3>
          <div id="events-list" class="muted">Belum ada jadwal.</div>
        </div>
      </section>

      <!-- PROFIL -->
      <section id="tab-profil">
        <div class="card">
          <h3>Profil</h3>
          <div class="grid grid-2">
            <div><label>Nama</label><input id="pf-name" /></div>
            <div><label>Email</label><input id="pf-email" /></div>
            <div style="grid-column:1/-1"><label>Alamat</label><input id="pf-address" /></div>
            <div style="grid-column:1/-1"><label>Catatan</label><textarea id="pf-notes" rows="3"></textarea></div>
            <div style="grid-column:1/-1" class="row"><button class="btn primary" onclick="saveProfile()">Simpan Profil</button><button class="btn" onclick="loadProfile()">Muat</button><button class="btn ghost" onclick="clearProfile()">Hapus</button></div>
          </div>
        </div>
      </section>

      <!-- VISUALISASI -->
      <section id="tab-visual">
        <div class="card">
          <h3>Visualisasi Data</h3>
          <div id="visual-charts" class="grid" style="grid-template-columns:repeat(auto-fit,minmax(280px,1fr));margin-top:8px;gap:12px">
            <div id="vc-fin" class="card"><h3 class="tiny muted">Pengeluaran per Kategori</h3><canvas id="chart-finance" height="180"></canvas></div>
            <div id="vc-summary" class="card"><h3 class="tiny muted">Ringkasan Pemasukan vs Pengeluaran</h3><canvas id="chart-summary" height="180"></canvas></div>
            <div id="vc-tasks" class="card"><h3 class="tiny muted">Tugas Over Time</h3><canvas id="chart-tasks" height="140"></canvas></div>
            <div id="vc-agenda" class="card"><h3 class="tiny muted">Agenda Timeline</h3><canvas id="chart-agenda" height="140"></canvas></div>
          </div>
        </div>
      </section>

    </main>

    <footer>Made with ♥ — Single-file, offline-first. Data stored locally in browser.</footer>
  </div>

<script>
/* ==================================================
   App: Personal Management (single-file)
   Features: login, finances, notes, tasks, events,
             profile, visualization, export/import.
   Author: generated (improved)
   ================================================== */

/* ------------------------------
   App State & Storage
   ------------------------------ */
const defaultStore = {
  finances: [], // {id,date,type,cat,desc,amount}
  notes: [],    // {id, text, dateISO}
  tasks: [],    // {id, text, date}
  events: [],   // {id, date, time, desc}
  profile: {}   // {name,email,address,notes}
};
let store = JSON.parse(localStorage.getItem('pm_store') || 'null') || defaultStore;
function saveAll(){ localStorage.setItem('pm_store', JSON.stringify(store)); }

/* ------------------------------
   Auth (simple)
   ------------------------------ */
function showLoginScreen(show){
  document.getElementById('login-screen').style.display = show ? 'flex' : 'none';
  // hide app tabs while login
  if(show){
    document.querySelectorAll('nav.tabs, main, .subtoggles, .controls').forEach(el=>el && (el.style.display='none'));
  } else {
    document.querySelectorAll('nav.tabs, main, .subtoggles, .controls').forEach(el=>el && (el.style.display='flex'));
    // ensure main visible
  }
}
const AUTH_KEY = 'pm_auth';
function initAuth(){
  const auth = JSON.parse(localStorage.getItem(AUTH_KEY) || 'null');
  if(!auth){ showLoginScreen(true); } else { showLoginScreen(false); initApp(); }
}
document.getElementById('btn-login')?.addEventListener('click', ()=>{
  const u = document.getElementById('login-user').value.trim();
  const p = document.getElementById('login-pass').value;
  const auth = JSON.parse(localStorage.getItem(AUTH_KEY) || 'null');
  if(auth && auth.username === u && auth.password === p){
    showLoginScreen(false); initApp(); return;
  }
  alert('Akun tidak ditemukan atau password salah. Silakan daftar (Register) jika belum punya.');
});
document.getElementById('btn-register')?.addEventListener('click', ()=>{
  const u = document.getElementById('login-user').value.trim();
  const p = document.getElementById('login-pass').value;
  if(!u || !p){ alert('Isi username & password untuk daftar'); return; }
  localStorage.setItem(AUTH_KEY, JSON.stringify({username:u, password:p}));
  alert('Registrasi berhasil. Silakan masuk menggunakan akun tersebut.');
});
document.getElementById('btn-guest')?.addEventListener('click', ()=>{
  // create guest auto account
  localStorage.setItem(AUTH_KEY, JSON.stringify({username:'guest', password:'guest'}));
  showLoginScreen(false); initApp();
});
document.getElementById('btn-logout')?.addEventListener('click', ()=>{
  if(confirm('Logout?')){ localStorage.removeItem(AUTH_KEY); showLoginScreen(true); }
});

/* ------------------------------
   Tabs init
   ------------------------------ */
const TABS = [
  {id:'dashboard', title:'Dashboard'},
  {id:'keuangan', title:'Keuangan'},
  {id:'notes', title:'Catatan'},
  {id:'tasks', title:'Tugas'},
  {id:'agenda', title:'Agenda'},
  {id:'profil', title:'Profil'},
  {id:'visual', title:'Visualisasi'},
];
function buildTabs(){
  const tabs = document.getElementById('tabs');
  tabs.innerHTML = '';
  TABS.forEach(t=>{
    const btn = document.createElement('button');
    btn.textContent = t.title;
    btn.dataset.target = 'tab-' + t.id;
    btn.onclick = ()=> switchTab(t.id);
    if(t.id==='dashboard') btn.classList.add('active');
    tabs.appendChild(btn);
  });
}
function switchTab(id){
  // header tabs active
  document.querySelectorAll('nav.tabs button').forEach(b=> b.classList.toggle('active', b.dataset.target === 'tab-' + id));
  // show section
  document.querySelectorAll('main section').forEach(s=> s.classList.toggle('active', s.id === 'tab-' + id));
  // render as needed
  if(id==='dashboard') renderDashboard();
  if(id==='keuangan') renderFinance();
  if(id==='notes') renderNotes();
  if(id==='tasks') renderTasks();
  if(id==='agenda') renderEvents();
  if(id==='profil') loadProfile();
  if(id==='visual') renderVisual();
}

/* ------------------------------
   Utilities
   ------------------------------ */
const IDR = new Intl.NumberFormat('id-ID', {style:'currency', currency:'IDR', maximumFractionDigits:0});
function uid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }
function todayYMD(){ return new Date().toISOString().slice(0,10); }
function fmtDateLocal(ymd){ if(!ymd) return '-'; const d = new Date(ymd + 'T00:00:00'); return d.toLocaleDateString('id-ID'); }

/* ------------------------------
   Dashboard
   ------------------------------ */
let dashChart;
function renderDashboard(){
  // compute sums
  let saldo=0, income=0, expense=0;
  const month = (new Date()).toISOString().slice(0,7);
  const byCat = {};
  store.finances.forEach(f=>{
    const a = Number(f.amount)||0;
    if(f.type==='income') { saldo += a; } else { saldo -= a; }
    if((f.date||'').startsWith(month)){
      if(f.type==='income') income += a; else expense += a;
      if(f.type==='expense'){ byCat[f.cat || 'Lainnya'] = (byCat[f.cat || 'Lainnya'] || 0) + a; }
    }
  });
  document.getElementById('dash-saldo').textContent = IDR.format(saldo);
  document.getElementById('dash-income').textContent = IDR.format(income);
  document.getElementById('dash-expense').textContent = IDR.format(expense);
  document.getElementById('dash-tasks').textContent = store.tasks.length;
  document.getElementById('dash-notes').textContent = store.notes.length;
  document.getElementById('dash-agenda').textContent = store.events.length;

  // upcoming events (7 days)
  const now = new Date();
  const week = new Date(now.getTime() + 7*24*3600*1000);
  const upcoming = store.events.map(e=> ({...e, dt: new Date(e.date + 'T' + (e.time || '00:00'))})).filter(e=> e.dt >= now && e.dt <= week).sort((a,b)=>a.dt-b.dt).slice(0,8);
  const ul = document.getElementById('upcoming-list'); ul.innerHTML = upcoming.length ? '' : '<div class="muted">Tidak ada agenda 7 hari ke depan.</div>';
  upcoming.forEach(u=>{
    const div = document.createElement('div');
    div.className = 'tiny';
    div.innerHTML = `<strong style="color:var(--accent)">${u.dt.toLocaleString('id-ID')}</strong> — ${u.desc}`;
    ul.appendChild(div);
  });

  // dash chart: byCat bar
  const ctx = document.getElementById('dash-chart').getContext('2d');
  const cats = Object.keys(byCat);
  const vals = cats.map(k=>byCat[k]);
  if(dashChart) dashChart.destroy();
  dashChart = new Chart(ctx, { type:'bar', data:{ labels:cats, datasets:[{label:'Pengeluaran (bulan ini)', data:vals, backgroundColor:'rgba(96,165,250,0.9)'}] }, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }});
}

/* ------------------------------
   Finance CRUD + Charts
   ------------------------------ */
let chartFinance, chartSummary;
function addTransaction(){
  const date = document.getElementById('fin-date').value || todayYMD();
  const type = document.getElementById('fin-type').value;
  const cat = (document.getElementById('fin-cat').value || '').trim();
  const desc = (document.getElementById('fin-desc').value || '').trim();
  const amount = Number(document.getElementById('fin-amount').value || 0);
  if(!amount) return alert('Jumlah tidak boleh 0');
  store.finances.push({ id: uid(), date, type, cat, desc, amount });
  saveAll(); clearFinanceForm(); renderFinance(); renderDashboard();
}
function clearFinanceForm(){
  document.getElementById('fin-date').value = ''; document.getElementById('fin-type').value = 'income';
  document.getElementById('fin-cat').value = ''; document.getElementById('fin-desc').value=''; document.getElementById('fin-amount').value='';
}
function deleteTransaction(id){
  if(!confirm('Hapus transaksi?')) return;
  store.finances = store.finances.filter(f => f.id !== id);
  saveAll(); renderFinance(); renderDashboard();
}
function monthOptionsForFilter(selId){
  const sel = document.getElementById(selId);
  const months = [...new Set(store.finances.map(f => (f.date||'').slice(0,7)).filter(Boolean))].sort().reverse();
  const cur = (new Date()).toISOString().slice(0,7);
  const opts = [cur, ...months.filter(m=>m!==cur)];
  sel.innerHTML = opts.map(m=>`<option value="${m}">${m}</option>`).join('');
}
function renderFinance(){
  monthOptionsForFilter('fin-filter');
  const month = document.getElementById('fin-filter').value || (new Date()).toISOString().slice(0,7);
  const rows = store.finances.filter(f => (f.date||'').startsWith(month)).sort((a,b)=> a.date.localeCompare(b.date));
  const tbody = document.getElementById('fin-tbody'); tbody.innerHTML = '';
  let saldo=0, inc=0, exp=0; const byCat = {};
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${fmtDateLocal(r.date)}</td><td><span class="pill">${r.type==='income'?'Pemasukan':'Pengeluaran'}</span></td><td>${r.cat||'-'}</td><td>${r.desc||'-'}</td><td><strong>${IDR.format(r.amount)}</strong></td><td><button class="icon-btn" title="Hapus" onclick="deleteTransaction('${r.id}')">✕</button></td>`;
    tbody.appendChild(tr);
    if(r.type==='income'){ inc += r.amount; saldo += r.amount; } else { exp += r.amount; saldo -= r.amount; byCat[r.cat||'Lainnya'] = (byCat[r.cat||'Lainnya']||0) + r.amount; }
  });
  document.getElementById('fin-sum').textContent = IDR.format(saldo);
  // finance charts
  // by category pie
  const finCtx = document.getElementById('chart-finance').getContext('2d');
  const catLabels = Object.keys(byCat);
  const catVals = catLabels.map(k=>byCat[k]);
  if(chartFinance) chartFinance.destroy();
  chartFinance = new Chart(finCtx, { type:'doughnut', data:{ labels:catLabels, datasets:[{ data:catVals, backgroundColor:['#60a5fa','#34d399','#f59e0b','#ef4444','#a78bfa'] }] }, options:{plugins:{legend:{position:'bottom'}}, maintainAspectRatio:false }});

  // summary chart (pemasukan vs pengeluaran for month)
  const summaryCtx = document.getElementById('chart-summary').getContext('2d');
  if(chartSummary) chartSummary.destroy();
  chartSummary = new Chart(summaryCtx, { type:'bar', data:{ labels:['Pemasukan','Pengeluaran'], datasets:[{ label:'Rp', data:[inc, exp], backgroundColor:['#10b981','#ef4444'] }] }, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }});
}

/* ------------------------------
   Notes
   ------------------------------ */
function addNote(){
  const txt = (document.getElementById('note-text').value || '').trim();
  if(!txt) return alert('Isi catatan terlebih dahulu.');
  store.notes.unshift({ id: uid(), text: txt, dateISO: new Date().toISOString() });
  saveAll(); document.getElementById('note-text').value = ''; renderNotes(); renderDashboard();
}
function delNote(id){
  if(!confirm('Hapus catatan?')) return;
  store.notes = store.notes.filter(n=> n.id !== id); saveAll(); renderNotes(); renderDashboard();
}
function renderNotes(){
  const wrap = document.getElementById('notes-list'); wrap.innerHTML = '';
  if(!store.notes.length){ wrap.innerHTML = '<div class="muted">Belum ada catatan.</div>'; return; }
  store.notes.forEach(n=>{
    const div = document.createElement('div');
    div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center'; div.style.marginBottom='8px';
    div.innerHTML = `<div><div class="muted">${new Date(n.dateISO).toLocaleString('id-ID')}</div><div>${n.text}</div></div><div><button class="btn ghost" onclick="delNote('${n.id}')">Hapus</button></div>`;
    wrap.appendChild(div);
  });
}

/* ------------------------------
   Tasks
   ------------------------------ */
function addTask(){
  const text = (document.getElementById('task-text').value || '').trim();
  const date = document.getElementById('task-date').value || todayYMD();
  if(!text) return alert('Masukkan tugas.');
  store.tasks.unshift({ id: uid(), text, date });
  saveAll(); document.getElementById('task-text').value=''; document.getElementById('task-date').value=''; renderTasks(); renderDashboard();
}
function toggleTaskDone(id){
  const t = store.tasks.find(x=>x.id===id); if(t) { t.done = !t.done; saveAll(); renderTasks(); renderDashboard(); }
}
function delTask(id){
  if(!confirm('Hapus tugas?')) return;
  store.tasks = store.tasks.filter(t=> t.id !== id); saveAll(); renderTasks(); renderDashboard();
}
function renderTasks(){
  const wrap = document.getElementById('tasks-list'); wrap.innerHTML = '';
  if(!store.tasks.length){ wrap.innerHTML = '<div class="muted">Belum ada tugas.</div>'; return; }
  store.tasks.forEach(t=>{
    const el = document.createElement('div');
    el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center'; el.style.marginBottom='8px';
    el.innerHTML = `<div><label style="cursor:pointer"><input type="checkbox" ${t.done? 'checked':''} onchange="toggleTaskDone('${t.id}')"> <strong style="color:var(--text)">${t.text}</strong><div class="muted">${fmtDateLocal(t.date)}</div></label></div><div><button class="btn ghost" onclick="delTask('${t.id}')">Hapus</button></div>`;
    wrap.appendChild(el);
  });
}

/* ------------------------------
   Events / Agenda
   ------------------------------ */
function addEvent(){
  const date = document.getElementById('evt-date').value || todayYMD();
  const time = document.getElementById('evt-time').value || '';
  const desc = (document.getElementById('evt-desc').value || '').trim();
  if(!desc) return alert('Deskripsi harus diisi.');
  store.events.push({ id: uid(), date, time, desc });
  saveAll(); document.getElementById('evt-date').value=''; document.getElementById('evt-time').value=''; document.getElementById('evt-desc').value=''; renderEvents(); renderDashboard();
}
function delEvent(id){
  if(!confirm('Hapus acara?')) return;
  store.events = store.events.filter(e=> e.id !== id); saveAll(); renderEvents(); renderDashboard();
}
function renderEvents(){
  const wrap = document.getElementById('events-list'); wrap.innerHTML = '';
  if(!store.events.length){ wrap.innerHTML = '<div class="muted">Belum ada jadwal.</div>'; return; }
  const list = [...store.events].sort((a,b)=> (a.date + (a.time||'')).localeCompare(b.date + (b.time||'')));
  list.forEach(e=>{
    const el = document.createElement('div');
    el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center'; el.style.marginBottom='8px';
    el.innerHTML = `<div><div class="muted">${fmtDateLocal(e.date)} ${e.time? '• ' + e.time : ''}</div><div>${e.desc}</div></div><div><button class="btn ghost" onclick="delEvent('${e.id}')">Hapus</button></div>`;
    wrap.appendChild(el);
  });
}

/* ------------------------------
   Profile
   ------------------------------ */
function saveProfile(){
  store.profile = {
    name: document.getElementById('pf-name').value.trim(),
    email: document.getElementById('pf-email').value.trim(),
    address: document.getElementById('pf-address').value.trim(),
    notes: document.getElementById('pf-notes').value.trim()
  };
  saveAll(); alert('Profil disimpan.'); renderDashboard();
}
function loadProfile(){
  const p = store.profile || {};
  document.getElementById('pf-name').value = p.name || '';
  document.getElementById('pf-email').value = p.email || '';
  document.getElementById('pf-address').value = p.address || '';
  document.getElementById('pf-notes').value = p.notes || '';
}
function clearProfile(){ if(confirm('Hapus profil?')){ store.profile = {}; saveAll(); loadProfile(); renderDashboard(); } }

/* ------------------------------
   Visualizations
   ------------------------------ */
let chartTasks, chartAgenda;
function renderVisual(){
  const showFin = document.getElementById('toggle-fin').checked;
  const showTasks = document.getElementById('toggle-tasks').checked;
  const showAgenda = document.getElementById('toggle-agenda').checked;
  // show/hide containers
  document.getElementById('vc-fin').style.display = showFin ? 'block' : 'none';
  document.getElementById('vc-summary').style.display = showFin ? 'block' : 'none';
  document.getElementById('vc-tasks').style.display = showTasks ? 'block' : 'none';
  document.getElementById('vc-agenda').style.display = showAgenda ? 'block' : 'none';

  // tasks chart (count per date)
  const tasksByDate = {};
  store.tasks.forEach(t=> { const d = t.date || todayYMD(); tasksByDate[d] = (tasksByDate[d]||0) + 1; });
  const tLabels = Object.keys(tasksByDate).sort();
  const tData = tLabels.map(d=>tasksByDate[d]);
  const tctx = document.getElementById('chart-tasks').getContext('2d');
  if(chartTasks) chartTasks.destroy();
  chartTasks = new Chart(tctx, { type:'line', data:{ labels:tLabels.map(l=>fmtDateLocal(l)), datasets:[{ label:'Jumlah tugas', data:tData, borderColor: 'rgba(96,165,250,1)', backgroundColor:'rgba(96,165,250,0.12)', fill:true }] }, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }});

  // agenda chart (timeline counts)
  const agendaByDate = {};
  store.events.forEach(a=> { agendaByDate[a.date] = (agendaByDate[a.date]||0) + 1; });
  const aLabels = Object.keys(agendaByDate).sort();
  const adata = aLabels.map(d=>agendaByDate[d]);
  const actx = document.getElementById('chart-agenda').getContext('2d');
  if(chartAgenda) chartAgenda.destroy();
  chartAgenda = new Chart(actx, { type:'bar', data:{ labels:aLabels.map(l=>fmtDateLocal(l)), datasets:[{ label:'Agenda', data:adata, backgroundColor:'rgba(245,158,11,0.9)' }] }, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }});
}

/* ------------------------------
   Export & Backup
   ------------------------------ */
async function exportExcel(){
  try{
    // build sheets via XLSX
    const wb = XLSX.utils.book_new();
    const finData = [['Tanggal','Jenis','Kategori','Deskripsi','Jumlah'], ...store.finances.map(f=>[f.date, f.type, f.cat||'', f.desc||'', f.amount])];
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(finData), 'Keuangan');
    const noteData = [['Waktu','Catatan'], ...store.notes.map(n=>[new Date(n.dateISO).toLocaleString('id-ID'), n.text])];
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(noteData), 'Catatan');
    const taskData = [['Tanggal','Tugas'], ...store.tasks.map(t=>[t.date, t.text])];
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(taskData), 'Tugas');
    const evtData = [['Tanggal','Waktu','Deskripsi'], ...store.events.map(e=>[e.date, e.time, e.desc])];
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(evtData), 'Agenda');
    const prof = store.profile || {};
    const profData = [['Field','Nilai'], ['Nama', prof.name||''], ['Email', prof.email||''], ['Alamat', prof.address||''], ['Catatan', prof.notes||'']];
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(profData), 'Profil');
    const wbout = XLSX.write(wb, { bookType:'xlsx', type:'array' });
    saveAs(new Blob([wbout], {type:'application/octet-stream'}), 'Personal-Management.xlsx');
  } catch(e){ alert('Gagal ekspor Excel: ' + e.message); }
}
async function exportWord(){
  try{
    const { Document, Packer, Paragraph, HeadingLevel, TextRun } = window.docx;
    const docChildren = [];
    const p = store.profile || {};
    docChildren.push(new Paragraph({ text: 'Profil', heading: HeadingLevel.HEADING_2 }));
    docChildren.push(new Paragraph({ children: [ new TextRun(`Nama: ${p.name||''}`) ] }));
    docChildren.push(new Paragraph({ children: [ new TextRun(`Email: ${p.email||''}`) ] }));
    docChildren.push(new Paragraph({ text: 'Keuangan', heading: HeadingLevel.HEADING_2 }));
    store.finances.forEach(f => { docChildren.push(new Paragraph({ children: [ new TextRun(`${f.date} | ${f.type} | ${f.cat||'-'} | ${f.desc||'-'} | ${IDR.format(f.amount)}`) ] })); });
    docChildren.push(new Paragraph({ text: 'Catatan', heading: HeadingLevel.HEADING_2 }));
    store.notes.forEach(n => docChildren.push(new Paragraph({ children: [ new TextRun(`${new Date(n.dateISO).toLocaleString('id-ID')} – ${n.text}`) ] })));
    docChildren.push(new Paragraph({ text: 'Tugas', heading: HeadingLevel.HEADING_2 }));
    store.tasks.forEach(t => docChildren.push(new Paragraph({ children: [ new TextRun(`${t.date} – ${t.text}`) ] })));
    docChildren.push(new Paragraph({ text: 'Agenda', heading: HeadingLevel.HEADING_2 }));
    store.events.forEach(ev => docChildren.push(new Paragraph({ children: [ new TextRun(`${ev.date} ${ev.time||''} – ${ev.desc}`) ] })));
    const doc = new Document({ sections: [{ properties: {}, children: docChildren }] });
    const blob = await Packer.toBlob(doc);
    saveAs(blob, 'Personal-Management.docx');
  } catch(e){ alert('Gagal ekspor Word: ' + e.message); }
}
function backupJSON(){
  const blob = new Blob([JSON.stringify(store, null, 2)], { type:'application/json' });
  saveAs(blob, 'pm-backup.json');
}
function importJSON(file){
  const reader = new FileReader();
  reader.onload = (ev) => {
    try{
      const data = JSON.parse(ev.target.result);
      // minimal validation
      if(!data || typeof data !== 'object') throw new Error('File tidak valid');
      store = Object.assign({}, defaultStore, data);
      saveAll(); renderAll();
      alert('Impor berhasil.');
    }catch(err){ alert('Gagal impor: ' + err.message); }
  };
  reader.readAsText(file);
}

/* ------------------------------
   Generic helpers
   ------------------------------ */
function deleteAll(key){
  if(!confirm('Hapus semua data untuk ' + key + ' ?')) return;
  if(Array.isArray(store[key])) store[key] = [];
  else store[key] = {};
  saveAll(); renderAll();
}

/* ------------------------------
   Wire up UI buttons & events
   ------------------------------ */
function hookUI(){
  buildTabs();
  // hook backup/import buttons
  document.getElementById('btn-backup').addEventListener('click', backupJSON);
  function backupJSON(){ backupJSON_(); } // wrapper
  function backupJSON_(){ backupJSON = backupJSON; } // noop to avoid linter confusion

  document.getElementById('import-json').addEventListener('change', (e)=>{
    const f = e.target.files?.[0]; if(f) importJSON(f);
    e.target.value = '';
  });
  document.getElementById('btn-backup').addEventListener('click', backupJSON);
  // logout handled earlier
  document.getElementById('btn-logout').addEventListener('click', ()=>{ if(confirm('Logout?')){ localStorage.removeItem(AUTH_KEY); showLoginScreen(true); } });

  // toggles update visual
  ['toggle-fin','toggle-tasks','toggle-agenda'].forEach(id=>{
    document.getElementById(id).addEventListener('change', ()=>{ if(document.getElementById('tab-visual').classList.contains('active')) renderVisual(); });
  });

  // filter initial value
  document.getElementById('fin-filter').addEventListener('change', renderFinance);

  // quick actions
  document.getElementById('btn-backup').addEventListener('click', backupJSON);

  // top-level import file (also present in Dashboard actions)
  document.getElementById('import-json').addEventListener('change', (e)=>{ const f = e.target.files?.[0]; if(f) importJSON(f); e.target.value=''; });

  // export buttons on dashboard (query by text)
  // create dynamic listeners for dashboard area using event delegation (not necessary but ok)
}

/* ------------------------------
   Initial render helpers
   ------------------------------ */
function renderAll(){
  renderDashboard(); renderFinance(); renderNotes(); renderTasks(); renderEvents(); loadProfile(); renderVisual();
}

/* ------------------------------
   Init App on successful auth
   ------------------------------ */
function initApp(){
  buildTabs();
  // show app area
  document.querySelectorAll('nav.tabs, main, .subtoggles, .controls').forEach(el=>el && (el.style.display='flex'));
  showLoginScreen(false);
  // default show dashboard
  switchTab('dashboard');
  // bind some buttons outside functions
  document.getElementById('btn-backup').addEventListener('click', backupJSON);
  // dashboard export/import buttons inside card — not individually needed as top controls handle them
  // Hook import in dashboard (duplicate element id import-json used)
  document.getElementById('import-json').addEventListener('change', (e)=>{ const f = e.target.files?.[0]; if(f) importJSON(f); e.target.value=''; });

  // attach click handlers for export within page (present as example)
  // The export buttons inside dashboard are created in markup via top controls; we can also add small inline listeners:
  // None in markup; we keep top control event.
  renderAll();
}

/* ------------------------------
   Small safety: ensure elements exist before adding listeners
   ------------------------------ */
(function attachSmallHandlers(){
  // backup/import & logout already set in hookUI/initApp
  // Attach quick export buttons in header if you want (omitted)
})();

/* ------------------------------
   Start
   ------------------------------ */
initAuth(); // show login if needed
hookUI();   // build tabs & wire toggles

// expose some functions to window for onclick calls from markup
window.switchTab = switchTab;
window.addTransaction = addTransaction;
window.clearFinanceForm = clearFinanceForm;
window.renderFinance = renderFinance;
window.addNote = addNote;
window.deleteAll = deleteAll;
window.addTask = addTask;
window.addEventListener('load', ()=>{
  // pre-populate filter options
  monthOptionsForFilter('fin-filter');
  // initial rendering of small components even if not logged in; actual rendering occurs on initApp
  renderAll();
});

// Expose export/import functions for UI use
window.exportExcel = exportExcel;
window.exportWord = exportWord;
window.backupData = backupJSON;
window.importJSON = importJSON;
window.deleteTransaction = deleteTransaction;
window.deleteEvent = delEvent;
window.saveProfile = saveProfile;
window.loadProfile = loadProfile;
window.clearProfile = clearProfile;

</script>
</body>
  </html>
